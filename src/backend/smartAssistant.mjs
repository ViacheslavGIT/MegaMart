import mongoose from "mongoose";
import Product from "./models/Product.mjs";

export async function smartAssistantReply(text) {
  if (mongoose.connection.readyState !== 1) {
    console.warn("‚ö†Ô∏è MongoDB –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ ‚Äî smartAssistant –Ω–µ –º–æ–∂–µ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –±–∞–∑–∏.");
    return "‚ö†Ô∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.";
  }

  const lower = text.toLowerCase();

  if (/(—Å–º–∞—Ä—Ç—Ñ|—Ç–µ–ª–µ—Ñ–æ–Ω|iphone|samsung|xiaomi)/.test(lower)) {
    const products = await Product.find({ category: /smartphone|phone/i }).limit(3);
    if (!products.length) return "üì¶ –ù–∞—Ä–∞–∑—ñ –Ω–µ–º–∞—î —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ —É –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ.";
    return (
      "üì± –û—Å—å –∫—ñ–ª—å–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ñ–≤:\n" +
      products.map((p) => `‚Ä¢ ${p.name} ‚Äî ‚Ç¥${p.price} (-${p.off}%)`).join("\n") +
      "\n–•–æ—á–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —á–∏ –¥—ñ–∑–Ω–∞—Ç–∏—Å—å –ø—Ä–æ –¥–æ—Å—Ç–∞–≤–∫—É?"
    );
  }

  if (/(–Ω–æ—É—Ç|macbook|laptop)/.test(lower)) {
    const laptops = await Product.find({ category: /laptop/i }).limit(3);
    if (!laptops.length) return "üíª –ó–∞—Ä–∞–∑ –Ω–æ—É—Ç–±—É–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ —É –ø—Ä–æ–¥–∞–∂—É.";
    return (
      "üíª –û—Å—å, —â–æ —î —É –ø—Ä–æ–¥–∞–∂—É:\n" +
      laptops.map((l) => `‚Ä¢ ${l.name} ‚Äî ‚Ç¥${l.price}`).join("\n") +
      "\n–•–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ —â–æ—Å—å —É –∫–æ—à–∏–∫?"
    );
  }

  if (/(—Ä–µ—î—Å—Ç—Ä|–∞–∫–∫–∞—É–Ω—Ç|—É–≤—ñ–π—Ç–∏|login)/.test(lower))
    return "üëã –í–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç –∞–±–æ —É–≤—ñ–π—Ç–∏ ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —É –º–µ–Ω—é ¬´Account¬ª.";
  if (/(–∫—É–ø–∏—Ç–∏|–∑–∞–º–æ–≤–∏—Ç–∏|–æ—Ñ–æ—Ä–º–∏—Ç–∏)/.test(lower))
    return "üõç –©–æ–± –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è, –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –∫–æ—à–∏–∫ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´Place an order¬ª.";
  if (/(–ø—Ä–∏–≤—ñ—Ç|–¥–æ–±—Ä|hi|hello)/.test(lower))
    return "üëã –í—ñ—Ç–∞—é! –Ø –ø–æ–º—ñ—á–Ω–∏–∫ MegaMart. –ú–æ–∂—É –ø–æ–∫–∞–∑–∞—Ç–∏ –Ω–æ–≤–∏–Ω–∫–∏ –∞–±–æ –∑–Ω–∏–∂–∫–∏.";

  return "ü§ñ –Ø –≤–∞—Å –ø–æ—á—É–≤, –∞–ª–µ –Ω–µ –≤–ø–µ–≤–Ω–µ–Ω–∏–π, —è–∫ –¥–æ–ø–æ–º–æ–≥—Ç–∏. –ù–∞–ø–∏—à—ñ—Ç—å, —â–æ —à—É–∫–∞—î—Ç–µ ‚Äî –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, '—Å–º–∞—Ä—Ç—Ñ–æ–Ω–∏ Samsung'.";
}
